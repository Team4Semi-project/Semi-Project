<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="kr.co.lemona.main.model.mapper.MainMapper">

	<select id="mainRecipeBoardList" resultType="Map">
		SELECT
		B.BOARD_NO,
		B.BOARD_CODE,
		B.BOARD_TITLE,
		B.READ_COUNT,
		M.MEMBER_NICKNAME,

		<!-- 댓글 수 -->
		(SELECT COUNT(*)
		FROM RECIPE_COMMENT C
		WHERE C.BOARD_NO = B.BOARD_NO) AS COMMENT_COUNT,

		<!-- 좋아요 수 -->
		(SELECT COUNT(*)
		FROM RECIPE_BOARD_LIKE L
		WHERE L.BOARD_NO = B.BOARD_NO) AS LIKE_COUNT,

      <![CDATA[
      CASE
        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24 / 60 
        THEN FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60 * 60) || '초 전'

        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24 
        THEN FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60) || '분 전'

        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 
        THEN FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24) || '시간 전'

        ELSE TO_CHAR(B.BOARD_CREATE_DATE, 'YYYY-MM-DD')
      END BOARD_CREATE_DATE
      ]]>

		FROM RECIPE_BOARD B
		JOIN MEMBER M ON (B.MEMBER_NO = M.MEMBER_NO)
		WHERE B.BOARD_DEL_FL = 'N'
		AND <![CDATA[ ROWNUM <= 2 ]]>
		ORDER BY B.BOARD_NO DESC

	</select>
	
	<!-- 최근 레시피 게시글 수 조회 -->
	<select id="getRecipeBoardListCount">
		SELECT COUNT(*)
		FROM "RECIPE_BOARD"
		WHERE BOARD_DEL_FL='N'
		AND CATEGORY_NO = #{categoryNo}
	</select>
	
	<!-- 특정 카테고리의 레시피 게시판 지정된 페이지 목록 조회 -->
	<select id="selectRecipeBoardList">
		SELECT 
		    B.BOARD_NO, 
		    B.BOARD_TITLE, 
		    B.READ_COUNT, 
		    M.MEMBER_NICKNAME,
		    B.BOARD_CODE,
		    M.PROFILE_IMG,
		
		    (SELECT COUNT(*) 
		     FROM RECIPE_COMMENT C
		     WHERE C.BOARD_NO = B.BOARD_NO) AS COMMENT_COUNT,
		
		    (SELECT COUNT(*) 
		     FROM RECIPE_BOARD_LIKE L
		     WHERE L.BOARD_NO = B.BOARD_NO) AS LIKE_COUNT,
		
		    S.IMG_PATH AS THUMBNAIL_IMG_PATH,
		    S.IMG_RENAME AS THUMBNAIL_IMG_RENAME,
		
		<![CDATA[
		    CASE
		        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24 / 60 THEN 
		            FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60 * 60) || '초 전'
		        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24 THEN 
		            FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 THEN 
		            FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24) || '시간 전'
		        ELSE 
		            TO_CHAR(B.BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END AS BOARD_CREATE_DATE
		]]>
		
		FROM RECIPE_BOARD B
		JOIN MEMBER M ON B.MEMBER_NO = M.MEMBER_NO
		
		LEFT JOIN (
		    SELECT BOARD_NO, IMG_PATH, IMG_RENAME
		    FROM BOARD_STEP
		    WHERE THUMBNAIL_CHECK = 'Y'
		) S ON B.BOARD_NO = S.BOARD_NO
		
		WHERE B.BOARD_DEL_FL = 'N'
		
		<!-- 카테고리 0 (전체) / 특정 카테고리일 경우 -->
		<if test="categoryNo != 0">
			AND CATEGORY_NO = #{categoryNo}
		</if>
		ORDER BY B.BOARD_NO DESC
	</select>
	
	<!-- 삭제되지 않은 게시글 수 -->
	<select id="getListCount">
	SELECT
	(SELECT COUNT(*) FROM BOARD WHERE BOARD_DEL_FL = 'N') +
	(SELECT COUNT(*) FROM RECIPE_BOARD WHERE BOARD_DEL_FL = 'N') AS total_count
	FROM DUAL
	</select>

	<!-- 검색 조건이 맞는 게시글 수 (BOARD + RECIPE_BOARD 합산) -->
	<select id="getSearchCount">
		SELECT
		(
		SELECT COUNT(*)
		FROM "BOARD"
		<if test='key == "w"'>
			JOIN "MEMBER" USING(MEMBER_NO)
		</if>
		WHERE BOARD_DEL_FL = 'N'
		<choose>
			<when test='key == "t"'>
				AND BOARD_TITLE LIKE '%' || #{query} || '%'
			</when>
			<when test='key == "c"'>
				AND BOARD_CONTENT LIKE '%' || #{query} || '%'
			</when>
			<when test='key == "tc"'>
				AND (
				BOARD_TITLE LIKE '%' || #{query} || '%'
				OR
				BOARD_CONTENT LIKE '%' || #{query} || '%'
				)
			</when>
			<when test='key == "w"'>
				AND MEMBER_NICKNAME LIKE '%' || #{query} || '%'
			</when>
		</choose>
		)
		+
		(
		SELECT COUNT(*)
		FROM "RECIPE_BOARD"
		<if test='key == "w"'>
			JOIN "MEMBER" USING(MEMBER_NO)
		</if>
		WHERE BOARD_DEL_FL = 'N'
		<choose>
			<when test='key == "t"'>
				AND BOARD_TITLE LIKE '%' || #{query} || '%'
			</when>
			<when test='key == "c"'>
				AND BOARD_CONTENT LIKE '%' || #{query} || '%'
			</when>
			<when test='key == "tc"'>
				AND (
				BOARD_TITLE LIKE '%' || #{query} || '%'
				OR
				BOARD_CONTENT LIKE '%' || #{query} || '%'
				)
			</when>
			<when test='key == "w"'>
				AND MEMBER_NICKNAME LIKE '%' || #{query} || '%'
			</when>
		</choose>
		) AS totalCount
		FROM DUAL
	</select>

	<!-- 인기 게시글 수 조회 -->
	<select id="getPopularListCount">
		<![CDATA[
		
		SELECT COUNT(*)
		FROM "RECIPE_BOARD" B
		JOIN (
		    SELECT BOARD_NO, COUNT(*) AS LIKE_COUNT
		    FROM "RECIPE_BOARD_LIKE"
		    GROUP BY BOARD_NO
		    HAVING COUNT(*) >= 0) L
		    ON B.BOARD_NO = L.BOARD_NO
		WHERE B.BOARD_DEL_FL = 'N'
		  AND B.READ_COUNT >= 20
		  AND MONTHS_BETWEEN(SYSDATE, B.BOARD_CREATE_DATE) <= 1
		  
		]]>
	</select>

	<!-- 인기 게시판 중 지정된 페이지 목록 조회 -->
	<select id="selectPopularBoardList">
		<![CDATA[
		
		SELECT 
		    B.BOARD_NO, 
		    B.BOARD_TITLE, 
		    B.READ_COUNT,
		    M.MEMBER_NICKNAME, 
		    M.PROFILE_IMG,
		    
		    (SELECT COUNT(*) 
		     FROM "RECIPE_COMMENT" C 
		     WHERE C.BOARD_NO = B.BOARD_NO) AS COMMENT_COUNT,
		
		    (SELECT COUNT(*) 
		     FROM "RECIPE_BOARD_LIKE" L 
		     WHERE L.BOARD_NO = B.BOARD_NO) AS LIKE_COUNT,
		
		    CASE
		        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24 / 60
		        THEN FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60 * 60) || '초 전'
		        
		        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24
		        THEN FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		        
		        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1
		        THEN FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24) || '시간 전'
		        
		        ELSE TO_CHAR(B.BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END AS BOARD_CREATE_DATE
		
		FROM "RECIPE_BOARD" B
		JOIN "MEMBER" M ON B.MEMBER_NO = M.MEMBER_NO
		
		WHERE B.BOARD_DEL_FL = 'N'
		  AND B.READ_COUNT >= 20
		  AND MONTHS_BETWEEN(SYSDATE, B.BOARD_CREATE_DATE) <= 1
		  AND (
		      SELECT COUNT(*) 
		      FROM "RECIPE_BOARD_LIKE" L 
		      WHERE L.BOARD_NO = B.BOARD_NO
		  ) >= 0
		
		ORDER BY 
		    (SELECT COUNT(*) 
		     FROM "RECIPE_BOARD_LIKE" L 
		     WHERE L.BOARD_NO = B.BOARD_NO) DESC
		  
		]]>
	</select>


	

</mapper>
