<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="kr.co.lemona.recipeBoard.model.mapper.RecipeBoardMapper">

	<!-- 게시글 수 조회 -->
	<select id="getRecipeBoardListCount">
		SELECT COUNT(*)
		FROM "RECIPE_BOARD"
		WHERE BOARD_DEL_FL='N'
		AND CATEGORY_NO = #{categoryNo}
	</select>
	
	<!-- 특정 카테고리의 레시피 게시판 지정된 페이지 목록 조회 -->
	<select id="selectRecipeBoardList">
		SELECT BOARD_NO, BOARD_TITLE, READ_COUNT, MEMBER_NICKNAME,
		(SELECT COUNT(*) FROM "RECIPE_COMMENT" C
		WHERE C.BOARD_NO  = B.BOARD_NO) COMMENT_COUNT,
		(SELECT COUNT(*) FROM "RECIPE_BOARD_LIKE" L
		WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT,
		
		<![CDATA[
			CASE
				WHEN SYSDATE - BOARD_CREATE_DATE < 1 / 24 / 60
				THEN FLOOR((SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60) || '초 전'
				
				WHEN SYSDATE - BOARD_CREATE_DATE < 1 / 24
				THEN FLOOR((SYSDATE - BOARD_CREATE_DATE) * 24 *60) || '분 전'
				
				WHEN SYSDATE - BOARD_CREATE_DATE < 1
				THEN FLOOR((SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
			ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
			END BOARD_CREATE_DATE
		]]>	
			
		FROM "RECIPE_BOARD" B
		JOIN "MEMBER"M ON(B.MEMBER_NO = M.MEMBER_NO )
		WHERE B.BOARD_DEL_FL ='N'
		<!-- 카테고리 0 (전체) / 특정 카테고리일 경우 -->
		<if test="categoryNo != 0">
			AND CATEGORY_NO = #{categoryNo}
		</if>
		ORDER BY BOARD_NO DESC
	</select>
	
	<!-- 인기 게시글 수 조회 -->
	<!-- 재호 -->
	<select id="getPopularListCount">
		<![CDATA[
		
		SELECT COUNT(*)
		FROM "RECIPE_BOARD" B
		JOIN (
		    SELECT BOARD_NO, COUNT(*) AS LIKE_COUNT
		    FROM "RECIPE_BOARD_LIKE"
		    GROUP BY BOARD_NO
		    HAVING COUNT(*) >= 0) L
		    ON B.BOARD_NO = L.BOARD_NO
		WHERE B.BOARD_DEL_FL = 'N'
		  AND B.READ_COUNT >= 20
		  AND MONTHS_BETWEEN(SYSDATE, B.BOARD_CREATE_DATE) <= 1
		  
		]]>
	</select>
	
	<!-- 인기 게시판 중 지정된 페이지 목록 조회 -->
	<!-- 재호 -->
	<select id="selectPopularBoardList">
		<![CDATA[
		
		SELECT 
		    B.BOARD_NO, 
		    B.BOARD_TITLE, 
		    B.READ_COUNT,
		    M.MEMBER_NICKNAME, 
		    M.PROFILE_IMG,
		    
		    (SELECT COUNT(*) 
		     FROM "RECIPE_COMMENT" C 
		     WHERE C.BOARD_NO = B.BOARD_NO) AS COMMENT_COUNT,
		
		    (SELECT COUNT(*) 
		     FROM "RECIPE_BOARD_LIKE" L 
		     WHERE L.BOARD_NO = B.BOARD_NO) AS LIKE_COUNT,
		
		    CASE
		        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24 / 60
		        THEN FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60 * 60) || '초 전'
		        
		        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24
		        THEN FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		        
		        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1
		        THEN FLOOR((SYSDATE - B.BOARD_CREATE_DATE) * 24) || '시간 전'
		        
		        ELSE TO_CHAR(B.BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END AS BOARD_CREATE_DATE
		
		FROM "RECIPE_BOARD" B
		JOIN "MEMBER" M ON B.MEMBER_NO = M.MEMBER_NO
		
		WHERE B.BOARD_DEL_FL = 'N'
		  AND B.READ_COUNT >= 20
		  AND MONTHS_BETWEEN(SYSDATE, B.BOARD_CREATE_DATE) <= 1
		  AND (
		      SELECT COUNT(*) 
		      FROM "RECIPE_BOARD_LIKE" L 
		      WHERE L.BOARD_NO = B.BOARD_NO
		  ) >= 0
		
		ORDER BY 
		    (SELECT COUNT(*) 
		     FROM "RECIPE_BOARD_LIKE" L 
		     WHERE L.BOARD_NO = B.BOARD_NO) DESC
		  
		]]>
	</select>
		
	
</mapper>